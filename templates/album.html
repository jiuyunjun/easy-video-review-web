<!doctype html>
<html lang='{{ "zh-CN" if lang=="zh" else ("ja" if lang=="ja" else "en" ) }}'>
<head>
  <meta charset='utf-8'>
  <title>{{ album }}</title>
  <meta name='viewport' content='width=device-width,initial-scale=1'>
  <link rel="icon" href="{{ url_for('static', filename='favicon.svg') }}" type="image/svg+xml">
  <style>
    :root{--gap:12px;--card-bg:#fff;--primary:#1976d2;--radius:8px;}
    *{box-sizing:border-box;}
    body{font-family:system-ui,Arial,sans-serif;margin:0;padding:var(--gap);background:#fafafa;}
    #upload{background:var(--card-bg);padding:var(--gap);border-radius:var(--radius);box-shadow:0 1px 3px rgba(0,0,0,.1);text-align:center;border:2px dashed #ccc;}
    button,.btn{background:var(--primary);color:#fff;border:none;border-radius:4px;padding:.5rem 1rem;text-decoration:none;display:inline-block;cursor:pointer;font:1rem/1.2 system-ui,Arial,sans-serif;}
    .actions{display:flex;justify-content:center;flex-wrap:wrap;gap:.5rem;margin-top:.5rem;}
    .editable{cursor:pointer;}
    button:disabled{opacity:.4;}
    #progwrap{display:none;height:20px;background:#e0e0e0;border-radius:10px;margin-top:6px;overflow:hidden;}
    #progbar{height:100%;width:0;background:#4caf50;transition:width .2s;}
    #progtext{font-size:.85rem;margin-top:4px;}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:var(--gap);margin-top:var(--gap);}
    figure{margin:0;padding:var(--gap);background:var(--card-bg);border-radius:var(--radius);box-shadow:0 1px 3px rgba(0,0,0,.08);display:flex;flex-direction:column;align-items:center;}
    figure img,figure video{width:100%;height:160px;object-fit:cover;border-radius:4px;cursor:pointer;}
    #filelist{margin-top:.5rem;text-align:left;font-size:.9rem;line-height:1.4;list-style:disc inside;max-height:200px;overflow:auto;}
    #filelist li{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    figcaption{margin-top:4px;font-size:.8rem;text-align:center;}
    figcaption .name{display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;word-break:break-all;min-height:2.4em;}
    figcaption .meta{font-size:.75rem;color:#666;display:block;line-height:1.2;}
    #overlay{position:fixed;inset:0;display:none;background:rgba(0,0,0,.85);align-items:center;justify-content:center;z-index:999;}
    #overlay img,#overlay video{max-width:90vw;max-height:90vh;border-radius:6px;transition:transform .2s;}
    #overlay img.dragging{transition:none;}
    #overlay .nav{position:absolute;top:50%;transform:translateY(-50%);background:rgba(0,0,0,.5);border:none;color:#fff;font-size:2rem;padding:.5rem;border-radius:50%;cursor:pointer;user-select:none;}
    #overlay #prev{left:1rem;}
    #overlay #next{right:1rem;}
  </style>
</head>
<body>
<h2>{{ album }} <button class='btn' onclick='renameAlbum()'>{{ t('rename','重命名') }}</button></h2>
<p style='font-size:.9rem;color:#555;'>
  {{ t('images','图片') }} {{ counts.image }} ，{{ t('videos','视频') }} {{ counts.video }} ，RAW {{ counts.raw }} ，{{ t('others','其他') }} {{ counts.other }}
</p>
<div style='text-align:right;margin-bottom:.5rem;'>
  {{ t('sort','排序') }}:
  <select id='sortsel' onchange="updateSort()">
    <option value='mtime' {% if sort=='mtime' %}selected{% endif %}>{{ t('sort_mtime','上传时间') }}</option>
    <option value='name' {% if sort=='name' %}selected{% endif %}>{{ t('sort_name','名称') }}</option>
    <option value='ctime' {% if sort=='ctime' %}selected{% endif %}>{{ t('sort_ctime','创建时间') }}</option>
    <option value='size' {% if sort=='size' %}selected{% endif %}>{{ t('sort_size','大小') }}</option>
  </select>
  <select id='ordersel' onchange="updateSort()">
    <option value='desc' {% if order=='desc' %}selected{% endif %}>{{ t('order_desc','降序') }}</option>
    <option value='asc' {% if order=='asc' %}selected{% endif %}>{{ t('order_asc','升序') }}</option>
  </select>
</div>
<div id='upload'>
  <p>{{ t('drop_prompt','拖拽文件到此或点击选择') }}</p>
  <input type='file' id='files' multiple style='display:none'>
  <div class='actions'>
    <button id='btnsel' class='btn' onclick='document.getElementById("files").click()'>{{ t('select_files','选择文件') }}</button>
    <button id='btnup' class='btn' onclick='upload()'>{{ t('upload','上传') }}</button>
    <a class='btn' href='javascript:void(0)' onclick='pack()'>{{ t('pack_download','打包下载') }}</a>
    <button class='btn' onclick='delAll()'>{{ t('clear_album','清空相册') }}</button>
  </div>
  <div id='progwrap'><div id='progbar'></div></div>
  <div id='progtext'></div>
  <ul id='filelist'></ul>
</div>
{% with m=get_flashed_messages() %}{% if m %}
<ul>
  {% for x in m %}<li style='color:#d32f2f;'>{{ x }}</li>{% endfor %}
</ul>
{% endif %}{% endwith %}
<div class='grid'>
{% for f in files %}{% set ext=f.name.split('.')[-1]|lower %}<figure>{% if ext in ['mp4','webm','ogg','avi','mov','mkv'] %}
  <a href='{{ lurl('review', album_name=album, filename=f.name) }}' target='_blank'>
    <video src='{{ lurl("stream", album_name=album, filename=f.name) }}#t=0.1' preload='metadata' muted></video>
  </a>
{% elif ext in ['dng','raw','nef','cr2','arw','rw2'] %}
  <img src='{{ lurl("thumb", album_name=album, filename=f.name) }}' data-full='{{ lurl("preview", album_name=album, filename=f.name) }}' onclick='showImage(this)'>
{% else %}
  <img src='{{ lurl("thumb", album_name=album, filename=f.name) }}' data-full='{{ url_for("static", filename=album+'/'+f.name) }}' onclick='showImage(this)'>
{% endif %}
  <figcaption>
    <span class='name editable' title='{{ f.name }}'>{{ f.name }}</span>
    <span class='meta'>{{ f.size | fmt_bytes }}</span>
    <span class='meta'>{{ t('uploaded','上传') }}: {{ f.mtime | fmt_time }}</span>
    <span class='meta'>{{ t('created','创建') }}: {{ f.ctime | fmt_time }}</span>
  </figcaption>
  <div class="actions">
    {% if ext in ['mp4','webm','ogg','avi','mov','mkv'] %}
    <button class='btn' onclick="exportFile('{{ f.name }}')">{{ t('export','导出') }}</button>
    {% endif %}
    <button class='btn' onclick="delFile('{{ f.name }}')">{{ t('delete','删除') }}</button>
  </div>
</figure>{% endfor %}
</div>
<div id='overlay'>
  <button id='prev' class='nav' onclick='event.stopPropagation();prev()'>&lsaquo;</button>
  <img>
  <button id='next' class='nav' onclick='event.stopPropagation();next()'>&rsaquo;</button>
</div>
<script>
const pw=document.getElementById('progwrap'),pb=document.getElementById('progbar'),pt=document.getElementById('progtext');
const drop=document.getElementById('upload');
const input=document.getElementById('files');
const filelist=document.getElementById('filelist');
let dropped=null;
const TXT={
  select_files_alert:"{{ t('select_files_alert','请选择文件') }}",
  confirm_upload:"{{ t('confirm_upload','确定上传 {n} 个文件吗?') }}",
  file_exists_replace:"{{ t('file_exists_replace','{name} 已存在，是否替换?') }}",
  upload_prepare:"{{ t('upload_prepare','准备上传...') }}",
  upload_failed:"{{ t('upload_failed','失败 {name}') }}",
  upload_done:"{{ t('upload_done','上传完成') }}",
  export_prepare:"{{ t('export_prepare','准备导出...') }}",
  export_progress:"{{ t('export_progress','导出 {percent}%') }}",
  export_running:"{{ t('export_running','导出中...') }}",
  export_done:"{{ t('export_done','导出完成') }}",
  export_failed:"{{ t('export_failed','导出失败') }}",
  confirm_delete_file:"{{ t('confirm_delete_file','删除 {name} ?') }}",
  confirm_clear_album:"{{ t('confirm_clear_album','确定清空相册?') }}",
  pack_progress:"{{ t('pack_progress','打包 {percent}%') }}",
  new_album_name:"{{ t('new_album_name','新相册名') }}",
  invalid_name:"{{ t('invalid_name','名称含非法字符') }}",
  rename_failed:"{{ t('rename_failed','重命名失败') }}"
};
function updateSort(){
  const s=document.getElementById('sortsel').value;
  const o=document.getElementById('ordersel').value;
  location.search='?sort='+s+'&order='+o;
}
drop.addEventListener('dragover',e=>{e.preventDefault();drop.style.background='#f0f8ff';});
drop.addEventListener('dragleave',()=>{drop.style.background='var(--card-bg)';});
drop.addEventListener('drop',e=>{e.preventDefault();drop.style.background='var(--card-bg)';dropped=e.dataTransfer.files;input.value='';showList(dropped);});
input.addEventListener('change',()=>{dropped=null;showList(input.files);});
function showList(fs){filelist.innerHTML='';for(const f of fs){const li=document.createElement('li');li.textContent=f.name;filelist.appendChild(li);}}
function fmt(b){const u=['B','KB','MB','GB','TB'];let i=0;while(b>=1024&&i<u.length-1){b/=1024;++i;}return b.toFixed(i?1:0)+' '+u[i];}
async function upload(){const fs=[...(dropped||input.files)];if(!fs.length)return alert(TXT.select_files_alert);if(!confirm(TXT.confirm_upload.replace('{n}',fs.length)))return;document.getElementById('btnup').disabled=true;pw.style.display='block';pb.style.width='0';pt.textContent=TXT.upload_prepare;let done=0,bytes=0,total=fs.reduce((a,b)=>a+b.size,0);
  const existing=new Set([...document.querySelectorAll('.grid .name')].map(e=>e.textContent.trim()));
  const limit=4;
  const queue=fs.slice();
  const work=async()=>{while(queue.length){const f=queue.shift();await doOne(f);} };
  const sanitize=n=>n.replace(/[\u0000-\u001F\u007F]/g,'').replace(/[\\\/]/g,'');
  const doOne=f=>new Promise(r=>{
    let name=sanitize(f.name);let overwrite=false;
    if(existing.has(name)){if(!confirm(TXT.file_exists_replace.replace('{name}',name))){bytes+=f.size;done++;r();return;}overwrite=true;}
    const send=()=>{
      const fd=new FormData();fd.append('file',f);
      const x=new XMLHttpRequest();
      x.open('POST',location.pathname+(overwrite?'?overwrite=1':''));
      x.upload.onprogress=e=>{pb.style.width=((bytes+e.loaded)/total*100).toFixed(1)+'%';pt.textContent=`${done}/${fs.length}  ${fmt(bytes+e.loaded)} / ${fmt(total)}`;};
      x.onload=()=>{
        if(x.status===409&&!overwrite){if(confirm(TXT.file_exists_replace.replace('{name}',name))){overwrite=true;send();}else{bytes+=f.size;done++;r();}}
        else{bytes+=f.size;done++;existing.add(name);r();}};
      x.onerror=()=>{alert(TXT.upload_failed.replace('{name}',name));bytes+=f.size;done++;r();};
      x.send(fd);
    };
    send();
  });
  const workers=Array(limit).fill(0).map(work);
  await Promise.all(workers);
  pt.textContent=TXT.upload_done;
  setTimeout(()=>location.reload(),500);} 
function exportFile(name){const x=new XMLHttpRequest();x.open('GET',`${location.pathname}/export/${encodeURIComponent(name)}`);x.responseType='blob';pw.style.display='block';pb.style.width='0';pt.textContent=TXT.export_prepare;x.onprogress=e=>{if(e.lengthComputable){pb.style.width=(e.loaded/e.total*100).toFixed(1)+'%';pt.textContent=TXT.export_progress.replace('{percent}',(e.loaded/e.total*100).toFixed(0));}else{pt.textContent=TXT.export_running;}};x.onload=()=>{if(x.status===200){const a=document.createElement('a');a.href=URL.createObjectURL(x.response);a.download=name.replace(/\.[^.]+$/,'')+'.zip';document.body.appendChild(a);a.click();a.remove();URL.revokeObjectURL(a.href);pt.textContent=TXT.export_done;setTimeout(()=>{pw.style.display='none';},1000);}else{alert(TXT.export_failed);pw.style.display='none';}};x.onerror=()=>{alert(TXT.export_failed);pw.style.display='none';};x.send();}
function delFile(name){if(!confirm(TXT.confirm_delete_file.replace('{name}',name)))return;fetch(location.pathname+'/delete',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({file:name})}).then(()=>location.reload());}
function delAll(){if(!confirm(TXT.confirm_clear_album))return;fetch(location.pathname+'/delete_all',{method:'POST'}).then(()=>location.reload());}
function pack(){const es=new EventSource(location.pathname+'/pack');pw.style.display='block';pb.style.width='0';pt.textContent='';es.onmessage=e=>{if(e.data==='done'){es.close();location.href=location.pathname+'/download_all';}else{pb.style.width=(parseFloat(e.data)*100).toFixed(1)+'%';pt.textContent=TXT.pack_progress.replace('{percent}',(parseFloat(e.data)*100).toFixed(0));}};}
function renameFile(oldName,newName){
  if(!newName||newName===oldName)return;
  fetch(location.pathname+'/rename_file',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({old:oldName,new:newName})
  }).then(()=>location.reload());
}

document.querySelectorAll('figcaption .name').forEach(span=>{
  span.addEventListener('click',()=>startEdit(span));
});

function startEdit(span){
  if(span.dataset.editing)return;
  span.dataset.editing='1';
  const old=span.textContent;
  const input=document.createElement('input');
  input.type='text';
  input.value=old;
  input.style.width='100%';
  span.replaceWith(input);
  input.focus();
  input.select();
  const finish=doRename=>{
    input.replaceWith(span);
    span.dataset.editing='';
    const val=input.value.trim();
    if(doRename&&val&&val!==old){
      renameFile(old,val);
    }else{
      span.textContent=old;
    }
  };
  input.addEventListener('blur',()=>finish(true));
  input.addEventListener('keydown',e=>{
    if(e.key==='Enter'){input.blur();}
    else if(e.key==='Escape'){input.value=old;finish(false);} 
  });
}
function renameAlbum(){
  const name=prompt(TXT.new_album_name, '{{ album }}');
  if(!name)return;
  if(!/^[A-Za-z0-9_]+$/.test(name)){alert(TXT.invalid_name);return;}
  fetch(location.pathname+'/rename',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({name})
  }).then(r=>r.json()).then(d=>{if(d.ok){location.href='/'+encodeURIComponent(d.new);}else{alert(TXT.rename_failed);}});
}
const items=[...document.querySelectorAll('.grid img')];
let idx=-1,scale=1,offX=0,offY=0;
function updateTransform(){
  const img=document.querySelector('#overlay img');
  img.style.transform=`translate(${offX}px,${offY}px) scale(${scale})`;
}
function showAt(i){
  if(i<0||i>=items.length)return;
  idx=i;scale=1;offX=0;offY=0;
  const o=document.getElementById('overlay');
  const img=o.querySelector('img');
  img.src=items[i].dataset.full;
  o.style.display='flex';
  updateTransform();
}
function showImage(el){showAt(items.indexOf(el));}
function hide(){const o=document.getElementById('overlay');o.style.display='none';idx=-1;}
function next(){if(idx<items.length-1)showAt(idx+1);}
function prev(){if(idx>0)showAt(idx-1);}
document.addEventListener('keydown',e=>{const o=document.getElementById('overlay');if(o.style.display!=='flex')return;if(e.key==='ArrowRight'){next();e.preventDefault();}else if(e.key==='ArrowLeft'){prev();e.preventDefault();}});
const overlay=document.getElementById('overlay');
const imgEl=document.querySelector('#overlay img');
let dragging=false,lastX=0,lastY=0;
imgEl.addEventListener('mousedown',e=>{
  if(e.button!==0)return;
  dragging=true;
  imgEl.classList.add('dragging');
  lastX=e.clientX;
  lastY=e.clientY;
  e.preventDefault();
  e.stopPropagation();
});
imgEl.addEventListener('click',e=>e.stopPropagation());
overlay.addEventListener('click',e=>{if(e.target===overlay)hide();});
document.addEventListener('mousemove',e=>{
  if(!dragging)return;
  offX+=e.clientX-lastX;
  offY+=e.clientY-lastY;
  lastX=e.clientX;
  lastY=e.clientY;
  updateTransform();
});
document.addEventListener('mouseup',()=>{
  dragging=false;
  imgEl.classList.remove('dragging');
});
overlay.addEventListener('wheel',e=>{e.preventDefault();const rect=imgEl.getBoundingClientRect();const cx=e.clientX-(rect.left+rect.width/2);const cy=e.clientY-(rect.top+rect.height/2);const old=scale;scale+=e.deltaY<0?0.1:-0.1;scale=Math.min(Math.max(scale,1),5);const ratio=scale/old;offX-=cx*(ratio-1);offY-=cy*(ratio-1);updateTransform();},{passive:false});
</script>
</body>
</html>
